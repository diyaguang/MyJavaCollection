第四章 从 Lucene到Elasticsearch

4.1 Elasticsearch概述

4.1.1 诞生过程
Lucene 只是一个由 Java语言编写的库，Elasticsearch底层使用的仍然是 Lucene的API，Lucene专注于底层搜索的建设，Elasticsearch专注于企业应用
Elasticaearch的目标是让全文检索变得简单，开发者可以通过简单明了的 RESTFul API轻松实现搜索功能，而不必去面对 Lucene的复杂性。
2010.2 Shay Banon发布了 Elasticsearch 的第一个版本
Elasticsearch衍生出来了一系列开源软件，统称为 Elastic Stack，主要包括分布式搜索引擎 Elasticsearch，日志采集与解析工具 Logstash，可视化分析平台 Kibana，数据采集工具 Beats家族。
其中 Elastcsearch，Logstash，Kibana 三者统称为 ELK Stack，非常流行的集中式日志采集与解析解决方案。
Beats结组，在数据收集方案使用 Beats取代了 Logstash，解决了 Logstash在各个服务器节点上占用系统资源高的问题。
Beast家族的5个成员：
1.Filebeat 轻量级的日志采集器，可用收集文件数据
2.Metricbeat 5.0版本之前称为 Topbeat，搜集系统，进程和文件系统级别的 CPU和内存使用情况等数据
3.Packetbeat 收集网路流数据，可以实时监控系统应用和服务，可以将延迟时间，错误，响应时间，SLA性能等信息发送到 Logstash 或 Elasticsearch中。
4.Winlogbeat 搜集 Windows事件日志数据
5.Heartbeat 监控服务器运行状态
从 5.0 版本开始，Elastic公司将各个组件的版本号统一，Elastic Stack的版本为 X.Y.Z 的形式，各组件的 Z可以不相同，但 X，Y必须一致。

4.1.2 流行度分析 （略）

4.1.3 架构解读
Gateway 是 Elasticsearch用来存储索引的文件系统，吃吃多种文件类型
Gateway 上层是一个分布式的 Lucene框架，底层API是由Lucene提供的，每个 Elasticsearch节点上都有一个 Lucene引擎的支持
Lucene 之上是 Elasticsearch的模块，包括索引模块，搜索模块，映射解析模块
Elasticsearch 模块之上的 Discovery，Scripting 和第三方插件。 这层主要用于ES的分布式集群，发现，选举 master节点等
再上层 是 Elasticsearch的传输模块和 JMX模块。默认是 HTTP传输，JMX是java管理框架，用来管理ES应用
最上层是 ES 提供给用户的接口，可以通过 RESTful API和 ES集群进行交互。

4.1.4 优点
分布式，全文检索，近实时搜索和分析，高可用，模式自由，RESTful API

4.1.5 应用场景
1.站内搜索
2.NoSQL数据库
3.日志分析

4.1.6 核心概念
1.集群 一个或多个安装 Elasticsearch的服务器节点组织在一起就是集群，共同持有整个的数据，并一起提供索引和搜索功能。一个集群由一个唯一的名字标示，具有相同集群名称的节点才会组成一个集群。
2.节点 一个节点是集群中的一个服务器，存储数据，参与集群的索引和搜索功能，通过配置集群名称的方式来加入一个指定的集群
3.索引 就是一个拥有几分相似特征的文档的集合，索引的数据结构仍然是倒排索引。一个索引由一个名字来标示，并且当我们要对这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用这个名字。在一个集群中，可以定义任意多的索引。
4.类型 在一个索引中，可以定义一种或多种类型。一个类型是你的索引的一个逻辑上的分类或分区，通常，会为具有一组共同字段的文档定义一个类型
5.文档 一个文档是一个可悲索引的基础信息但愿，通常都是 JSON格式
6.分片 一个索引可以存储超出单个节点硬件限制的大量数据，ES提供了将索引划分为多份的能力，这些份就叫做分片。当创建索引时，可以指定想要的分片数量，每个分片本身也是一个功能完善并且独立的“索引”，这个索引可以背方知道集群中的任何节点上。
特点1:允许水平分割、扩展内容容量，特点2:允许在分片上进行分布式的，并行的操作，提高性能和吞吐量
7.副本
ES允许创建分片的一份或多份拷贝，称为复制分片或副本
特点1:在分片、节点失败的情况下，保证高可用性。特点2:扩展搜索量、吞吐量，搜索可以在所有的副本上并行运行。

总结：每个索引可以背分成多个分片，一个索引可以有一至多个副本。一旦有了副本，每个索引就有了主分片和副本分片之别。分片和副本的数量可以在索引创建的时候指定。在索引创建之后，可以在任何时候动态地改变副本的数量，但是事后不能改变分片的数量。

4.1.7 对比 RDMS
ES可以看成一个数据库。数据库=》索引，表=〉类型，行=》文档，列=〉字段，表结构=》映射，索引=〉全文索引，SQL=》查询DSL
我们可以这样理解：某个索引下的某个类型的某个文档，和关系数据库讲的 某个数据库中的某张表的某条记录是等价的。

4.1.8 文档结构
ES中的基本单位是文档，文档用 JSON来标示。
JSON是一种轻量级的数据交换格式。主要有以下两种结构：
1.key/value健值对结构，包括字段名称（在双引号中），后面写一个冒号，然后是值。类似："name":"Tom"
2.数组结构，也称为值的有序列表。
JSON 值的类型可以是数字，字符串（在双引号之内），布尔值（true/false），数组（在方括号之内），对象（在花括号之内），null
JSON 对象在花括号中书写，对象可以包含多个名称/值对